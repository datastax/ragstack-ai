name: CI - RAGStack tests
on:
  pull_request:
    branches:
      - main

concurrency:
  group: ragstack-tests-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-docker:
    name: Docker
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Docker examples - basic
        run: |
          docker --version
          cd docker/examples/basic
          sudo docker build -t ragstack-basic .

      - name: Docker examples - multistage
        run: |
          cd docker/examples/multistage
          sudo docker build -t ragstack-multistage .
      - name: Docker examples - local llm
        run: |
          cd docker/examples/local-llm
          sudo docker build -t local-llm .

  tests:
    name: Unit and Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: "Setup: Python 3.11"
        uses: ./.github/actions/setup-python

      - name: "Build"
        run: |
          poetry install --no-root -E colbert
          poetry build

      - name: Run ragstack-ai unit and integration tests
        env:
          COLBERT_ASTRA_TOKEN: ${{ secrets.COLBERT_ASTRA_TOKEN }}
          COLBERT_ASTRA_SCB: ${{ secrets.COLBERT_ASTRA_SCB }}
        run: |
          tox
