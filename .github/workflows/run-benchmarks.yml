name: Run benchmarks

on:
  workflow_dispatch:
    inputs:
      intensity:
        description: 'Intensity of the tests (1-5)'
        default: "2"

jobs:
  run-benchmarks:
    name: Run benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Set up python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install tox
          
          
      - name: Run
        env:
          OPEN_AI_KEY: "${{ secrets.E2E_TESTS_OPEN_AI_KEY }}"
          NVIDIA_API_KEY: "${{ secrets.E2E_TESTS_NVIDIA_API_KEY }}"
        run: |
          cd ragstack-e2e-tests
          poetry install --no-root
          poetry run python benchmarks/runner.py -t all -i ${{ github.event.inputs.intensity }}
          poetry run python benchmarks/visualize.py

      - name: Dump logs
        if: always()
        run: |
          cd ragstack-e2e-tests
          if [ -f "testcases.log" ]; then
            cat testcases.log
          fi
