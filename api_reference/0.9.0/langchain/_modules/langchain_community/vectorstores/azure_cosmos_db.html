

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>langchain_community.vectorstores.azure_cosmos_db &mdash; ðŸ¦œðŸ”— LangChain 0.1.12</title>
  
  <link rel="canonical" href="https://api.python.langchain.com/en/latest/_modules/langchain_community/vectorstores/azure_cosmos_db.html" />

  

  <link rel="stylesheet" href="../../../_static/css/vendor/bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/autodoc_pydantic.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx-dropdown.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/panels-bootstrap.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
<script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
<script src="../../../_static/jquery.js"></script> 
</head>
<body>


<nav id="navbar" class="sk-docs-navbar navbar navbar-expand-md navbar-light bg-light py-0">
  <div class="container-fluid sk-docs-container px-0">
    <button
      id="sk-navbar-toggler"
      class="navbar-toggler"
      type="button"
      data-toggle="collapse"
      data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="sk-navbar-collapse collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="sk-nav-link nav-link" href="../../../langchain_api_reference.html">LangChain</a>
        </li>
        <li class="nav-item">
          <a class="sk-nav-link nav-link" href="../../../core_api_reference.html">Core</a>
        </li>
        <li class="nav-item">
          <a class="sk-nav-link nav-link" href="../../../community_api_reference.html">Community</a>
        </li>
        <li class="nav-item">
          <a class="sk-nav-link nav-link" href="../../../experimental_api_reference.html">Experimental</a>
        </li>
        <li class="nav-item">
          <a class="sk-nav-link nav-link" href="../../../text_splitters_api_reference.html">Text splitters</a>
        </li>
        <li class="nav-item dropdown nav-more-item-dropdown">
          <a class="sk-nav-link nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Partner libs</a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
          </div>
        </li>
        <li class="nav-item">
          <a class="sk-nav-link nav-link" target="_blank" rel="noopener noreferrer" href="https://python.langchain.com/">Docs</a>
        </li>
      </ul>
      <div id="searchbox" role="search">
          <div class="searchformwrapper">
          <form class="search" action="../../../search.html" method="get">
            <input class="sk-search-text-input" type="text" name="q" aria-labelledby="searchlabel" />
            <input class="sk-search-text-btn" type="submit" value="Go" />
          </form>
          </div>
      </div>
    </div>
  </div>
</nav>
<div class="d-flex" id="sk-doc-wrapper">
    <input type="checkbox" name="sk-toggle-checkbox" id="sk-toggle-checkbox">
    <label id="sk-sidemenu-toggle" class="sk-btn-toggle-toc btn sk-btn-primary" for="sk-toggle-checkbox">Toggle Menu</label>
    <div id="sk-sidebar-wrapper" class="border-right">
      <div class="sk-sidebar-toc-wrapper">
        <div class="btn-group w-100 mb-2" role="group" aria-label="rellinks">
            <a href="#" role="button" class="btn sk-btn-rellink py-1 disabled"">Prev</a><a href="../../index.html" role="button" class="btn sk-btn-rellink py-1" sk-rellink-tooltip="Module code">Up</a>
            <a href="#" role="button" class="btn sk-btn-rellink py-1 disabled"">Next</a>
        </div>
            <div class="sk-sidebar-toc">
              
            </div>
      </div>
    </div>
    <div id="sk-page-content-wrapper">
      <div class="sk-page-content container-fluid body px-md-3" role="main">
        
  <h1>Source code for langchain_community.vectorstores.azure_cosmos_db</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Generator</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">langchain_core.documents</span> <span class="kn">import</span> <span class="n">Document</span>
<span class="kn">from</span> <span class="nn">langchain_core.vectorstores</span> <span class="kn">import</span> <span class="n">VectorStore</span>

<span class="kn">from</span> <span class="nn">langchain_community.vectorstores.utils</span> <span class="kn">import</span> <span class="n">maximal_marginal_relevance</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">langchain_core.embeddings</span> <span class="kn">import</span> <span class="n">Embeddings</span>
    <span class="kn">from</span> <span class="nn">pymongo.collection</span> <span class="kn">import</span> <span class="n">Collection</span>


<span class="c1"># Before Python 3.11 native StrEnum is not available</span>
<div class="viewcode-block" id="CosmosDBSimilarityType"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.CosmosDBSimilarityType.html#langchain_community.vectorstores.azure_cosmos_db.CosmosDBSimilarityType">[docs]</a><span class="k">class</span> <span class="nc">CosmosDBSimilarityType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cosmos DB Similarity Type as enumerator.&quot;&quot;&quot;</span>

    <span class="n">COS</span> <span class="o">=</span> <span class="s2">&quot;COS&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CosineSimilarity&quot;&quot;&quot;</span>
    <span class="n">IP</span> <span class="o">=</span> <span class="s2">&quot;IP&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;inner - product&quot;&quot;&quot;</span>
    <span class="n">L2</span> <span class="o">=</span> <span class="s2">&quot;L2&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Euclidean distance&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="CosmosDBVectorSearchType"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.CosmosDBVectorSearchType.html#langchain_community.vectorstores.azure_cosmos_db.CosmosDBVectorSearchType">[docs]</a><span class="k">class</span> <span class="nc">CosmosDBVectorSearchType</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cosmos DB Vector Search Type as enumerator.&quot;&quot;&quot;</span>

    <span class="n">VECTOR_IVF</span> <span class="o">=</span> <span class="s2">&quot;vector-ivf&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;IVF vector index&quot;&quot;&quot;</span>
    <span class="n">VECTOR_HNSW</span> <span class="o">=</span> <span class="s2">&quot;vector-hnsw&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HNSW vector index&quot;&quot;&quot;</span></div>


<span class="n">CosmosDBDocumentType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;CosmosDBDocumentType&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">DEFAULT_INSERT_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">128</span>


<div class="viewcode-block" id="AzureCosmosDBVectorSearch"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch">[docs]</a><span class="k">class</span> <span class="nc">AzureCosmosDBVectorSearch</span><span class="p">(</span><span class="n">VectorStore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;`Azure Cosmos DB for MongoDB vCore` vector store.</span>

<span class="sd">    To use, you should have both:</span>
<span class="sd">    - the ``pymongo`` python package installed</span>
<span class="sd">    - a connection string associated with a MongoDB VCore Cluster</span>

<span class="sd">    Example:</span>
<span class="sd">        . code-block:: python</span>

<span class="sd">            from langchain_community.vectorstores import AzureCosmosDBVectorSearch</span>
<span class="sd">            from langchain_community.embeddings.openai import OpenAIEmbeddings</span>
<span class="sd">            from pymongo import MongoClient</span>

<span class="sd">            mongo_client = MongoClient(&quot;&lt;YOUR-CONNECTION-STRING&gt;&quot;)</span>
<span class="sd">            collection = mongo_client[&quot;&lt;db_name&gt;&quot;][&quot;&lt;collection_name&gt;&quot;]</span>
<span class="sd">            embeddings = OpenAIEmbeddings()</span>
<span class="sd">            vectorstore = AzureCosmosDBVectorSearch(collection, embeddings)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.__init__"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">collection</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">CosmosDBDocumentType</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">index_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;vectorSearchIndex&quot;</span><span class="p">,</span>
        <span class="n">text_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;textContent&quot;</span><span class="p">,</span>
        <span class="n">embedding_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;vectorContent&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor for AzureCosmosDBVectorSearch</span>

<span class="sd">        Args:</span>
<span class="sd">            collection: MongoDB collection to add the texts to.</span>
<span class="sd">            embedding: Text embedding model to use.</span>
<span class="sd">            index_name: Name of the Atlas Search index.</span>
<span class="sd">            text_key: MongoDB field that will contain the text</span>
<span class="sd">                for each document.</span>
<span class="sd">            embedding_key: MongoDB field that will contain the embedding</span>
<span class="sd">                for each document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span> <span class="o">=</span> <span class="n">collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_embedding</span> <span class="o">=</span> <span class="n">embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span> <span class="o">=</span> <span class="n">index_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text_key</span> <span class="o">=</span> <span class="n">text_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_key</span> <span class="o">=</span> <span class="n">embedding_key</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">embeddings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Embeddings</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding</span>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.get_index_name"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.get_index_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_index_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the index name</span>

<span class="sd">        Returns:</span>
<span class="sd">            Returns the index name</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span></div>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.from_connection_string"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.from_connection_string">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_connection_string</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">connection_string</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AzureCosmosDBVectorSearch</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an Instance of AzureCosmosDBVectorSearch from a Connection String</span>

<span class="sd">        Args:</span>
<span class="sd">            connection_string: The MongoDB vCore instance connection string</span>
<span class="sd">            namespace: The namespace (database.collection)</span>
<span class="sd">            embedding: The embedding utility</span>
<span class="sd">            **kwargs: Dynamic keyword arguments</span>

<span class="sd">        Returns:</span>
<span class="sd">            an instance of the vector store</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">MongoClient</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Could not import pymongo, please install it with &quot;</span>
                <span class="s2">&quot;`pip install pymongo`.&quot;</span>
            <span class="p">)</span>
        <span class="n">client</span><span class="p">:</span> <span class="n">MongoClient</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">connection_string</span><span class="p">)</span>
        <span class="n">db_name</span><span class="p">,</span> <span class="n">collection_name</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="n">db_name</span><span class="p">][</span><span class="n">collection_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">embedding</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.index_exists"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.index_exists">[docs]</a>    <span class="k">def</span> <span class="nf">index_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verifies if the specified index name during instance</span>
<span class="sd">            construction exists on the collection</span>

<span class="sd">        Returns:</span>
<span class="sd">          Returns True on success and False if no such index exists</span>
<span class="sd">            on the collection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">list_indexes</span><span class="p">()</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">current_index_name</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_index_name</span> <span class="o">==</span> <span class="n">index_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.delete_index"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.delete_index">[docs]</a>    <span class="k">def</span> <span class="nf">delete_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deletes the index specified during instance construction if it exists&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span><span class="p">)</span></div>
            <span class="c1"># Raises OperationFailure on an error (e.g. trying to drop</span>
            <span class="c1"># an index that does not exist)</span>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.create_index"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.create_index">[docs]</a>    <span class="k">def</span> <span class="nf">create_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_lists</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">dimensions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1536</span><span class="p">,</span>
        <span class="n">similarity</span><span class="p">:</span> <span class="n">CosmosDBSimilarityType</span> <span class="o">=</span> <span class="n">CosmosDBSimilarityType</span><span class="o">.</span><span class="n">COS</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;vector-ivf&quot;</span><span class="p">,</span>
        <span class="n">m</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
        <span class="n">ef_construction</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates an index using the index name specified at</span>
<span class="sd">            instance construction</span>

<span class="sd">        Setting the numLists parameter correctly is important for achieving</span>
<span class="sd">            good accuracy and performance.</span>
<span class="sd">            Since the vector store uses IVF as the indexing strategy,</span>
<span class="sd">            you should create the index only after you</span>
<span class="sd">            have loaded a large enough sample documents to ensure that the</span>
<span class="sd">            centroids for the respective buckets are</span>
<span class="sd">            faily distributed.</span>

<span class="sd">        We recommend that numLists is set to documentCount/1000 for up</span>
<span class="sd">            to 1 million documents</span>
<span class="sd">            and to sqrt(documentCount) for more than 1 million documents.</span>
<span class="sd">            As the number of items in your database grows, you should</span>
<span class="sd">            tune numLists to be larger</span>
<span class="sd">            in order to achieve good latency performance for vector search.</span>

<span class="sd">            If you&#39;re experimenting with a new scenario or creating a</span>
<span class="sd">            small demo, you can start with numLists</span>
<span class="sd">            set to 1 to perform a brute-force search across all vectors.</span>
<span class="sd">            This should provide you with the most</span>
<span class="sd">            accurate results from the vector search, however be aware that</span>
<span class="sd">            the search speed and latency will be slow.</span>
<span class="sd">            After your initial setup, you should go ahead and tune</span>
<span class="sd">            the numLists parameter using the above guidance.</span>

<span class="sd">        Args:</span>
<span class="sd">            kind: Type of vector index to create.</span>
<span class="sd">                Possible options are:</span>
<span class="sd">                    - vector-ivf</span>
<span class="sd">                    - vector-hnsw: available as a preview feature only,</span>
<span class="sd">                                   to enable visit https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/preview-features</span>
<span class="sd">            num_lists: This integer is the number of clusters that the</span>
<span class="sd">                inverted file (IVF) index uses to group the vector data.</span>
<span class="sd">                We recommend that numLists is set to documentCount/1000</span>
<span class="sd">                for up to 1 million documents and to sqrt(documentCount)</span>
<span class="sd">                for more than 1 million documents.</span>
<span class="sd">                Using a numLists value of 1 is akin to performing</span>
<span class="sd">                brute-force search, which has limited performance</span>
<span class="sd">            dimensions: Number of dimensions for vector similarity.</span>
<span class="sd">                The maximum number of supported dimensions is 2000</span>
<span class="sd">            similarity: Similarity metric to use with the IVF index.</span>

<span class="sd">                Possible options are:</span>
<span class="sd">                    - CosmosDBSimilarityType.COS (cosine distance),</span>
<span class="sd">                    - CosmosDBSimilarityType.L2 (Euclidean distance), and</span>
<span class="sd">                    - CosmosDBSimilarityType.IP (inner product).</span>
<span class="sd">            m: The max number of connections per layer (16 by default, minimum</span>
<span class="sd">               value is 2, maximum value is 100). Higher m is suitable for datasets</span>
<span class="sd">               with high dimensionality and/or high accuracy requirements.</span>
<span class="sd">            ef_construction: the size of the dynamic candidate list for constructing</span>
<span class="sd">                            the graph (64 by default, minimum value is 4, maximum</span>
<span class="sd">                            value is 1000). Higher ef_construction will result in</span>
<span class="sd">                            better index quality and higher accuracy, but it will</span>
<span class="sd">                            also increase the time required to build the index.</span>
<span class="sd">                            ef_construction has to be at least 2 * m</span>
<span class="sd">        Returns:</span>
<span class="sd">            An object describing the created index</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check the kind of vector search to be performed</span>
        <span class="c1"># prepare the command accordingly</span>
        <span class="n">create_index_commands</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">CosmosDBVectorSearchType</span><span class="o">.</span><span class="n">VECTOR_IVF</span><span class="p">:</span>
            <span class="n">create_index_commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vector_index_ivf</span><span class="p">(</span>
                <span class="n">kind</span><span class="p">,</span> <span class="n">num_lists</span><span class="p">,</span> <span class="n">similarity</span><span class="p">,</span> <span class="n">dimensions</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">CosmosDBVectorSearchType</span><span class="o">.</span><span class="n">VECTOR_HNSW</span><span class="p">:</span>
            <span class="n">create_index_commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_vector_index_hnsw</span><span class="p">(</span>
                <span class="n">kind</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">ef_construction</span><span class="p">,</span> <span class="n">similarity</span><span class="p">,</span> <span class="n">dimensions</span>
            <span class="p">)</span>

        <span class="c1"># retrieve the database object</span>
        <span class="n">current_database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">database</span>

        <span class="c1"># invoke the command from the database object</span>
        <span class="n">create_index_responses</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_database</span><span class="o">.</span><span class="n">command</span><span class="p">(</span>
            <span class="n">create_index_commands</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">create_index_responses</span></div>

    <span class="k">def</span> <span class="nf">_get_vector_index_ivf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_lists</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">similarity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;createIndexes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;indexes&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span><span class="p">,</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_embedding_key</span><span class="p">:</span> <span class="s2">&quot;cosmosSearch&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;cosmosSearchOptions&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                        <span class="s2">&quot;numLists&quot;</span><span class="p">:</span> <span class="n">num_lists</span><span class="p">,</span>
                        <span class="s2">&quot;similarity&quot;</span><span class="p">:</span> <span class="n">similarity</span><span class="p">,</span>
                        <span class="s2">&quot;dimensions&quot;</span><span class="p">:</span> <span class="n">dimensions</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">],</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">command</span>

    <span class="k">def</span> <span class="nf">_get_vector_index_hnsw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ef_construction</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">similarity</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;createIndexes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;indexes&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index_name</span><span class="p">,</span>
                    <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_embedding_key</span><span class="p">:</span> <span class="s2">&quot;cosmosSearch&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;cosmosSearchOptions&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                        <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="n">m</span><span class="p">,</span>
                        <span class="s2">&quot;efConstruction&quot;</span><span class="p">:</span> <span class="n">ef_construction</span><span class="p">,</span>
                        <span class="s2">&quot;similarity&quot;</span><span class="p">:</span> <span class="n">similarity</span><span class="p">,</span>
                        <span class="s2">&quot;dimensions&quot;</span><span class="p">:</span> <span class="n">dimensions</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">],</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">command</span>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.add_texts"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.add_texts">[docs]</a>    <span class="k">def</span> <span class="nf">add_texts</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch_size&quot;</span><span class="p">,</span> <span class="n">DEFAULT_INSERT_BATCH_SIZE</span><span class="p">)</span>
        <span class="n">_metadatas</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">Generator</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadatas</span> <span class="ow">or</span> <span class="p">({}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">)</span>
        <span class="n">texts_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">metadatas_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">result_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">_metadatas</span><span class="p">)):</span>
            <span class="n">texts_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">metadatas_batch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">batch_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_insert_texts</span><span class="p">(</span><span class="n">texts_batch</span><span class="p">,</span> <span class="n">metadatas_batch</span><span class="p">))</span>
                <span class="n">texts_batch</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">metadatas_batch</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">texts_batch</span><span class="p">:</span>
            <span class="n">result_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_insert_texts</span><span class="p">(</span><span class="n">texts_batch</span><span class="p">,</span> <span class="n">metadatas_batch</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result_ids</span></div>

    <span class="k">def</span> <span class="nf">_insert_texts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">metadatas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to Load Documents into the collection</span>

<span class="sd">        Args:</span>
<span class="sd">            texts: The list of documents strings to load</span>
<span class="sd">            metadatas: The list of metadata objects associated with each document</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the text is empty, then exit early</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">texts</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># Embed and create the documents</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding</span><span class="o">.</span><span class="n">embed_documents</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
        <span class="n">to_insert</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_key</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_key</span><span class="p">:</span> <span class="n">embedding</span><span class="p">,</span> <span class="o">**</span><span class="n">m</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">embedding</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">metadatas</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># insert the documents in Cosmos DB</span>
        <span class="n">insert_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">to_insert</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">insert_result</span><span class="o">.</span><span class="n">inserted_ids</span>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.from_texts"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.from_texts">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_texts</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">Embeddings</span><span class="p">,</span>
        <span class="n">metadatas</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">collection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Collection</span><span class="p">[</span><span class="n">CosmosDBDocumentType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AzureCosmosDBVectorSearch</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">collection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide &#39;collection&#39; named parameter.&quot;</span><span class="p">)</span>
        <span class="n">vectorstore</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">embedding</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">vectorstore</span><span class="o">.</span><span class="n">add_texts</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">metadatas</span><span class="o">=</span><span class="n">metadatas</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vectorstore</span></div>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.delete"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No document ids provided to delete.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">document_id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_document_by_id</span><span class="p">(</span><span class="n">document_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.delete_document_by_id"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.delete_document_by_id">[docs]</a>    <span class="k">def</span> <span class="nf">delete_document_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes a Specific Document by Id</span>

<span class="sd">        Args:</span>
<span class="sd">            document_id: The document identifier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">bson.objectid</span> <span class="kn">import</span> <span class="n">ObjectId</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;Unable to import bson, please install with `pip install bson`.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">if</span> <span class="n">document_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No document id provided to delete.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">delete_one</span><span class="p">({</span><span class="s2">&quot;_id&quot;</span><span class="p">:</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">document_id</span><span class="p">)})</span></div>

    <span class="k">def</span> <span class="nf">_similarity_search_with_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embeddings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="n">CosmosDBVectorSearchType</span> <span class="o">=</span> <span class="n">CosmosDBVectorSearchType</span><span class="o">.</span><span class="n">VECTOR_IVF</span><span class="p">,</span>
        <span class="n">ef_search</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
        <span class="n">score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a list of documents with their scores</span>

<span class="sd">        Args:</span>
<span class="sd">            embeddings: The query vector</span>
<span class="sd">            k: the number of documents to return</span>
<span class="sd">            kind: Type of vector index to create.</span>
<span class="sd">                Possible options are:</span>
<span class="sd">                    - vector-ivf</span>
<span class="sd">                    - vector-hnsw: available as a preview feature only,</span>
<span class="sd">                                   to enable visit https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/preview-features</span>
<span class="sd">            ef_search: The size of the dynamic candidate list for search</span>
<span class="sd">                       (40 by default). A higher value provides better</span>
<span class="sd">                       recall at the cost of speed.</span>
<span class="sd">            score_threshold: (Optional[float], optional): Maximum vector distance</span>
<span class="sd">                between selected documents and the query vector. Defaults to None.</span>
<span class="sd">                Only vector-ivf search supports this for now.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of documents closest to the query vector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pipeline</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">CosmosDBVectorSearchType</span><span class="o">.</span><span class="n">VECTOR_IVF</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipeline_vector_ivf</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">CosmosDBVectorSearchType</span><span class="o">.</span><span class="n">VECTOR_HNSW</span><span class="p">:</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pipeline_vector_hnsw</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ef_search</span><span class="p">)</span>

        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

        <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;similarityScore&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="n">score_threshold</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">document_object_field</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">res</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;document&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">CosmosDBVectorSearchType</span><span class="o">.</span><span class="n">VECTOR_IVF</span>
                <span class="k">else</span> <span class="n">res</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">document_object_field</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text_key</span><span class="p">)</span>
            <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">Document</span><span class="p">(</span><span class="n">page_content</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">document_object_field</span><span class="p">),</span> <span class="n">score</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">docs</span>

    <span class="k">def</span> <span class="nf">_get_pipeline_vector_ivf</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">pipeline</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;$search&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;cosmosSearch&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;vector&quot;</span><span class="p">:</span> <span class="n">embeddings</span><span class="p">,</span>
                        <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_key</span><span class="p">,</span>
                        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;returnStoredSource&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;similarityScore&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$meta&quot;</span><span class="p">:</span> <span class="s2">&quot;searchScore&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;document&quot;</span><span class="p">:</span> <span class="s2">&quot;$$ROOT&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">pipeline</span>

    <span class="k">def</span> <span class="nf">_get_pipeline_vector_hnsw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">embeddings</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ef_search</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="n">pipeline</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;$search&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;cosmosSearch&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;vector&quot;</span><span class="p">:</span> <span class="n">embeddings</span><span class="p">,</span>
                        <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding_key</span><span class="p">,</span>
                        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                        <span class="s2">&quot;efSearch&quot;</span><span class="p">:</span> <span class="n">ef_search</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;$project&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;similarityScore&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$meta&quot;</span><span class="p">:</span> <span class="s2">&quot;searchScore&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;document&quot;</span><span class="p">:</span> <span class="s2">&quot;$$ROOT&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">pipeline</span>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.similarity_search_with_score"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.similarity_search_with_score">[docs]</a>    <span class="k">def</span> <span class="nf">similarity_search_with_score</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="n">CosmosDBVectorSearchType</span> <span class="o">=</span> <span class="n">CosmosDBVectorSearchType</span><span class="o">.</span><span class="n">VECTOR_IVF</span><span class="p">,</span>
        <span class="n">ef_search</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
        <span class="n">score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Document</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_similarity_search_with_score</span><span class="p">(</span>
            <span class="n">embeddings</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">ef_search</span><span class="o">=</span><span class="n">ef_search</span><span class="p">,</span>
            <span class="n">score_threshold</span><span class="o">=</span><span class="n">score_threshold</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">docs</span></div>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.similarity_search"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.similarity_search">[docs]</a>    <span class="k">def</span> <span class="nf">similarity_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="n">CosmosDBVectorSearchType</span> <span class="o">=</span> <span class="n">CosmosDBVectorSearchType</span><span class="o">.</span><span class="n">VECTOR_IVF</span><span class="p">,</span>
        <span class="n">ef_search</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
        <span class="n">score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
        <span class="n">docs_and_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">similarity_search_with_score</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">ef_search</span><span class="o">=</span><span class="n">ef_search</span><span class="p">,</span>
            <span class="n">score_threshold</span><span class="o">=</span><span class="n">score_threshold</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">doc</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">docs_and_scores</span><span class="p">]</span></div>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.max_marginal_relevance_search_by_vector"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.max_marginal_relevance_search_by_vector">[docs]</a>    <span class="k">def</span> <span class="nf">max_marginal_relevance_search_by_vector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="n">CosmosDBVectorSearchType</span> <span class="o">=</span> <span class="n">CosmosDBVectorSearchType</span><span class="o">.</span><span class="n">VECTOR_IVF</span><span class="p">,</span>
        <span class="n">ef_search</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
        <span class="n">score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
        <span class="c1"># Retrieves the docs with similarity scores</span>
        <span class="c1"># sorted by similarity scores in DESC order</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_similarity_search_with_score</span><span class="p">(</span>
            <span class="n">embedding</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">ef_search</span><span class="o">=</span><span class="n">ef_search</span><span class="p">,</span>
            <span class="n">score_threshold</span><span class="o">=</span><span class="n">score_threshold</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Re-ranks the docs using MMR</span>
        <span class="n">mmr_doc_indexes</span> <span class="o">=</span> <span class="n">maximal_marginal_relevance</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">embedding</span><span class="p">),</span>
            <span class="p">[</span><span class="n">doc</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_embedding_key</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">],</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mmr_docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">docs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mmr_doc_indexes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">mmr_docs</span></div>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.max_marginal_relevance_search"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.max_marginal_relevance_search">[docs]</a>    <span class="k">def</span> <span class="nf">max_marginal_relevance_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">fetch_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">lambda_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="n">CosmosDBVectorSearchType</span> <span class="o">=</span> <span class="n">CosmosDBVectorSearchType</span><span class="o">.</span><span class="n">VECTOR_IVF</span><span class="p">,</span>
        <span class="n">ef_search</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
        <span class="n">score_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Document</span><span class="p">]:</span>
        <span class="c1"># compute the embeddings vector from the query string</span>
        <span class="n">embeddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_embedding</span><span class="o">.</span><span class="n">embed_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">docs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_marginal_relevance_search_by_vector</span><span class="p">(</span>
            <span class="n">embeddings</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">fetch_k</span><span class="o">=</span><span class="n">fetch_k</span><span class="p">,</span>
            <span class="n">lambda_mult</span><span class="o">=</span><span class="n">lambda_mult</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">ef_search</span><span class="o">=</span><span class="n">ef_search</span><span class="p">,</span>
            <span class="n">score_threshold</span><span class="o">=</span><span class="n">score_threshold</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">docs</span></div>

<div class="viewcode-block" id="AzureCosmosDBVectorSearch.get_collection"><a class="viewcode-back" href="../../../vectorstores/langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.html#langchain_community.vectorstores.azure_cosmos_db.AzureCosmosDBVectorSearch.get_collection">[docs]</a>    <span class="k">def</span> <span class="nf">get_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Collection</span><span class="p">[</span><span class="n">CosmosDBDocumentType</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collection</span></div></div>
</pre></div>

      </div>
    <div class="container">
      <footer class="sk-content-footer">
            &copy; 2023, LangChain, Inc..
          Last updated on Mar 15, 2024.
      </footer>
    </div>
  </div>
</div>
<script src="../../../_static/js/vendor/bootstrap.min.js"></script>
<script>
$(document).ready(function() {
    /* Add a [>>>] button on the top-right corner of code samples to hide
     * the >>> and ... prompts and the output and thus make the code
     * copyable. */
    var div = $('.highlight-python .highlight,' +
                '.highlight-python3 .highlight,' +
                '.highlight-pycon .highlight,' +
		'.highlight-default .highlight')
    var pre = div.find('pre');

    // get the styles from the current theme
    pre.parent().parent().css('position', 'relative');
    var hide_text = 'Hide prompts and outputs';
    var show_text = 'Show prompts and outputs';

    // create and add the button to all the code blocks that contain >>>
    div.each(function(index) {
        var jthis = $(this);
        if (jthis.find('.gp').length > 0) {
            var button = $('<span class="copybutton">&gt;&gt;&gt;</span>');
            button.attr('title', hide_text);
            button.data('hidden', 'false');
            jthis.prepend(button);
        }
        // tracebacks (.gt) contain bare text elements that need to be
        // wrapped in a span to work with .nextUntil() (see later)
        jthis.find('pre:has(.gt)').contents().filter(function() {
            return ((this.nodeType == 3) && (this.data.trim().length > 0));
        }).wrap('<span>');
    });

    // define the behavior of the button when it's clicked
    $('.copybutton').click(function(e){
        e.preventDefault();
        var button = $(this);
        if (button.data('hidden') === 'false') {
            // hide the code output
            button.parent().find('.go, .gp, .gt').hide();
            button.next('pre').find('.gt').nextUntil('.gp, .go').css('visibility', 'hidden');
            button.css('text-decoration', 'line-through');
            button.attr('title', show_text);
            button.data('hidden', 'true');
        } else {
            // show the code output
            button.parent().find('.go, .gp, .gt').show();
            button.next('pre').find('.gt').nextUntil('.gp, .go').css('visibility', 'visible');
            button.css('text-decoration', 'none');
            button.attr('title', hide_text);
            button.data('hidden', 'false');
        }
    });

	/*** Add permalink buttons next to glossary terms ***/
	$('dl.glossary > dt[id]').append(function() {
		return ('<a class="headerlink" href="#' +
			    this.getAttribute('id') +
			    '" title="Permalink to this term">Â¶</a>');
	});
});

</script>
    
</body>
</html>